#include "text_renderer.h"
#include <string.h>
#include <stdio.h>


// Framebuffer definition
uint8_t framebuf[X_BYTES * Y_LINES];

// Simple 5x7 font definition
typedef struct {char c; uint8_t data[5];} font_char_t;
static const font_char_t font5x7[] ={
    {' ', {0x00,0x00,0x00,0x00,0x00}},
    {'0', {0x3E,0x51,0x49,0x45,0x3E}},
    {'1', {0x00,0x42,0x7F,0x40,0x00}},
    {'2', {0x62,0x51,0x49,0x49,0x46}},
    {'3', {0x22,0x41,0x49,0x49,0x36}},
    {'4', {0x18,0x14,0x12,0x7F,0x10}},
    {'5', {0x2F,0x49,0x49,0x49,0x31}},
    {'6', {0x3E,0x49,0x49,0x49,0x30}},
    {'7', {0x01,0x71,0x09,0x05,0x03}},
    {'8', {0x36,0x49,0x49,0x49,0x36}},
    {'9', {0x06,0x49,0x49,0x29,0x1E}},
    {':', {0x00,0x36,0x36,0x00,0x00}},

    { 'A', {0x7E,0x11,0x11,0x11,0x7E} },
    { 'B', {0x7F,0x49,0x49,0x49,0x36} },
    { 'C', {0x3E,0x41,0x41,0x41,0x22} },
    { 'D', {0x7F,0x41,0x41,0x22,0x1C} },
    { 'E', {0x7F,0x49,0x49,0x49,0x41} },
    { 'F', {0x7F,0x09,0x09,0x09,0x01} },
    { 'G', {0x3E,0x41,0x49,0x49,0x7A} },
    { 'H', {0x7F,0x08,0x08,0x08,0x7F} },
    { 'I', {0x00,0x41,0x7F,0x41,0x00} },
    { 'J', {0x20,0x40,0x41,0x3F,0x01} },
    { 'K', {0x7F,0x08,0x14,0x22,0x41} },
    { 'L', {0x7F,0x40,0x40,0x40,0x40} },
    { 'M', {0x7F,0x02,0x0C,0x02,0x7F} },
    { 'N', {0x7F,0x04,0x08,0x10,0x7F} },
    { 'O', {0x3E,0x41,0x41,0x41,0x3E} },
    { 'P', {0x7F,0x09,0x09,0x09,0x06} },
    { 'Q', {0x3E,0x41,0x51,0x21,0x5E} },
    { 'R', {0x7F,0x09,0x19,0x29,0x46} },
    { 'S', {0x46,0x49,0x49,0x49,0x31} },
    { 'T', {0x01,0x01,0x7F,0x01,0x01} },
    { 'U', {0x3F,0x40,0x40,0x40,0x3F} },
    { 'V', {0x1F,0x20,0x40,0x20,0x1F} },
    { 'W', {0x7F,0x20,0x18,0x20,0x7F} },
    { 'X', {0x63,0x14,0x08,0x14,0x63} },
    { 'Y', {0x07,0x08,0x70,0x08,0x07} },
    { 'Z', {0x61,0x51,0x49,0x45,0x43} },

    { 'a', {0x30,0x48,0x44,0x24,0x7C} },
    { 'b', {0x7F,0x48,0x44,0x44,0x38} },
    { 'c', {0x38,0x44,0x44,0x44,0x20} },
    { 'd', {0x38,0x44,0x44,0x48,0x7F} },
    { 'e', {0x38,0x54,0x54,0x54,0x18} },
    { 'f', {0x08,0x7E,0x09,0x01,0x02} },
    { 'g', {0x0C,0x52,0x52,0x52,0x3E} },
    { 'h', {0x7F,0x08,0x04,0x04,0x78} },
    { 'i', {0x00,0x00,0x7A,0x00,0x00} },
    { 'j', {0x20,0x40,0x44,0x3D,0x00} },
    { 'k', {0x7F,0x10,0x28,0x44,0x00} },
    { 'l', {0x00,0x41,0x7F,0x40,0x00} },
    { 'm', {0x7C,0x04,0x18,0x04,0x78} },
    { 'n', {0x7C,0x08,0x04,0x04,0x78} },
    { 'o', {0x30,0x48,0x48,0x48,0x30} },
    { 'p', {0x7C,0x14,0x14,0x14,0x08} },
    { 'q', {0x08,0x14,0x14,0x18,0x7C} },
    { 'r', {0x7C,0x08,0x04,0x04,0x08} },
    { 's', {0x48,0x54,0x54,0x54,0x24} },
    { 't', {0x04,0x3E,0x44,0x40,0x20} },
    { 'u', {0x3C,0x40,0x40,0x20,0x7C} },
    { 'v', {0x0C,0x30,0x40,0x30,0x0C} },
    { 'w', {0x3C,0x40,0x30,0x40,0x3C} },
    { 'x', {0x44,0x28,0x10,0x28,0x44} },
    { 'y', {0x0C,0x50,0x50,0x50,0x3C} },
    { 'z', {0x44,0x64,0x54,0x4C,0x44} },
};
static const uint8_t logo[] = {// SKN MOS, 96x32px
0xff, 0xff, 0xff, 0x07, 0x03, 0x03, 0xff, 0xff, 0x03, 0x03, 0xff, 0xff, 0x03, 0x03, 0xff, 0xff, 
0x03, 0x03, 0x07, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x7f, 0xff, 0x9f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
0x0f, 0x0f, 0x1f, 0x3f, 0x7f, 0xdf, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x1f, 0x3f, 0x7f, 
0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x1f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 
0x0f, 0x0f, 0x0f, 0x0f, 0x1f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x1f, 0x0f, 
0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0xff, 0xf7, 0xff, 0xf7, 0x7f, 0x0f, 0x1f, 0xff, 0xff, 
0xff, 0xff, 0x07, 0x03, 0x02, 0x03, 0x03, 0x03, 0x02, 0x02, 0x03, 0x03, 0x02, 0x02, 0x03, 0x03, 
0x32, 0x32, 0x03, 0x07, 0xff, 0xf1, 0x0e, 0x1f, 0x1f, 0x1e, 0x04, 0x01, 0xf6, 0xfe, 0xfe, 0xfe, 
0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfe, 0xfe, 0xfe, 0xfe, 0xfc, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x01, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfe, 0xfe, 0xfe, 0xfe, 
0xfe, 0xfe, 0xe0, 0x3c, 0x7e, 0x7e, 0x7e, 0x1d, 0x03, 0xc7, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 
0x30, 0x3c, 0x3e, 0x3e, 0x3e, 0x3e, 0x7e, 0x7e, 0xfd, 0xfd, 0xfc, 0xfc, 0xfc, 0xfe, 0xff, 0xff, 
0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 
0xff, 0xf0, 0xe0, 0xe0, 0xc0, 0xe0, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0xff, 0xcf, 0xf8, 0xf8, 0xfc, 0x78, 0x30, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 
0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x7f, 0x7e, 0xfc, 0xf8, 
0xf8, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0x00, 0x00, 0x01, 0x01, 0x03, 0x07, 0xff, 0xff, 0xff, 
0xff, 0xff, 0xff, 0x83, 0x81, 0x81, 0xff, 0xff, 0x81, 0x81, 0xff, 0xff, 0x81, 0x81, 0xff, 0xff, 
0x81, 0x81, 0x83, 0xff, 0xff, 0xff, 0xf8, 0xf0, 0xe0, 0xe0, 0xe0, 0xf0, 0xff, 0xff, 0xff, 0xff, 
0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf1, 0xde, 0xbf, 0xbf, 0x9f, 
0x8e, 0x80, 0xe7, 0xff, 0xff, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 
0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0, 0xf8, 0xfc, 0xff, 0xf1, 0xdf, 0xdf, 0x9f, 0x9f, 0x8e, 
0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0, 0xf8, 0xfc, 0xff, 0xff, 0xff};

static const int FONT_COUNT = sizeof(font5x7) / sizeof(font5x7[0]);

// Initialize renderer: clear framebuff to white
void text_renderer_init(void){
    memset(framebuf, 0xFF, sizeof(framebuf));
}

// Set a single pixel in framebuff to black
static void set_pixel(int x, int y){
    if( x < 0 || x >= EPD_WIDTH  ||  y < 0 || y >= EPD_HEIGHT) return;
    int idx = y * X_BYTES + (x >> 3);
    int bit = 7 - (x & 7);
     framebuf[idx] &= ~(1 << bit);
}


static void draw_char(int x, int y, char c){
    for (int i = 0; i < FONT_COUNT; i++) {
        if (font5x7[i].c == c){
            for (int col = 0; col < 5; col++){
                uint8_t bits = font5x7[i].data[col];
                for (int row = 0; row < 7; row++){
                    if (bits & (1 << row)){
                        set_pixel(x + col, y + row);
                    }
                }
            }
            return;
        }
    }
}




static void draw_logo() {
    int LOGO_WIDTH = 96;
    int LOGO_HEIGHT = 32;

    int LOGO_Y_BYTES = (LOGO_HEIGHT / 8);
    int LOGO_SIZE = (LOGO_WIDTH * LOGO_Y_BYTES);

    int y_offset = EPD_HEIGHT - LOGO_HEIGHT;
    int x_offset = EPD_WIDTH - LOGO_WIDTH;

    for (int y_byte = 0; y_byte < LOGO_Y_BYTES; y_byte++) {
        for (int x = 0; x < LOGO_WIDTH; x++) {
            uint8_t byte = logo[y_byte * LOGO_WIDTH + x];
            for (int bit = 0; bit < 8; bit++) {
                if ((byte >> bit) & 1) {
                    set_pixel(x_offset + x, y_offset + y_byte * 8 + bit);
                }
            }
        }
    }
}



static void draw_string(int x0, int y0, const char *s){

    int x = x0;
    int y = y0;

    const int spacing = 7; // character width + 2 pixels
    while (*s){
        if (*s == '\n'){
            y += 8; // line height + spacing
            x = x0; // reset column
        }

        int space_left = EPD_WIDTH - x;
        
        const char *word_start = s;
        int chars = 0;
        while(s[chars] && s[chars] != ' ' && s[chars] != '\n'){
            chars++;
        }
        int width = chars * spacing;

        if(x-x0 + width > space_left){
            x = x0;
            y+=8;
        }

        for(int i = 0; i < chars; i++){
            draw_char(x, y, word_start[i]);
            x += spacing;
        }

        if (s[chars] == ' ') {
            x += spacing;
            s += chars + 1;
        } else { // '\n'
            s += chars;
        }
    }
}

static void printInTerminal(){
    for (int yy = 0; yy < Y_LINES; yy++) {
        for (int xb = 0; xb < X_BYTES; xb++) {
            size_t idx = yy * X_BYTES + xb;
            if (idx >= X_BYTES * Y_LINES) {
                fprintf(stderr, "Out of bounds index %zu\n", idx);
                return;
            }
            uint8_t byte = framebuf[idx];
            for (int bit = 7; bit >= 0; bit--) {
                putchar((byte & (1 << bit)) ? ' ' : 'x');
            }
        }
        putchar('\n');
    }
}